pipeline {
    agent any

    parameters {
        string(
            name: 'IMAGE_DATE_TAG',
            defaultValue: '',
            description: 'GAì—ì„œ ë¹Œë“œí•œ ë‚ ì§œ íƒœê·¸ (ì˜ˆ: 20251208-153045). ìµœì¢… íƒœê·¸ëŠ” fe-<ì´ ê°’>ìœ¼ë¡œ ì‚¬ìš©'
        )
    }

    environment {
        AWS_REGION      = 'ap-northeast-2'
        ACCOUNT_ID      = '557690602093'
        REGISTRY        = "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        IMAGE_NAME      = 'ktb-personal'

        // ì‹¤ì œ í”„ë¡ íŠ¸ì—”ë“œ Target Group ARN ìœ¼ë¡œ êµì²´
        FRONTEND_TG_ARN = 'arn:aws:elasticloadbalancing:ap-northeast-2:557690602093:targetgroup/ktb-personal-project-fe/a15b80c5eb204235'
    }

    stages {
        stage('Resolve Frontend Targets') {
            steps {
                script {
                    // 1) íƒ€ê²Ÿê·¸ë£¹ â†’ ì¸ìŠ¤í„´ìŠ¤ ID
                    def instanceIds = sh(
                        script: """
                          aws elbv2 describe-target-health \\
                            --region ${AWS_REGION} \\
                            --target-group-arn ${FRONTEND_TG_ARN} \\
                            --query 'TargetHealthDescriptions[].Target.Id' \\
                            --output text
                        """,
                        returnStdout: true
                    ).trim()

                    if (!instanceIds) {
                        error "í”„ë¡ íŠ¸ì—”ë“œ íƒ€ê²Ÿê·¸ë£¹ì— ë“±ë¡ëœ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
                    }

                    // 2) ì¸ìŠ¤í„´ìŠ¤ ID â†’ í”„ë¼ì´ë¹— IP
                    def frontendIps = sh(
                        script: """
                          aws ec2 describe-instances \\
                            --region ${AWS_REGION} \\
                            --instance-ids ${instanceIds} \\
                            --query 'Reservations[].Instances[].PrivateIpAddress' \\
                            --output text
                        """,
                        returnStdout: true
                    ).trim().split()

                    echo "í”„ë¡ íŠ¸ì—”ë“œ ëŒ€ìƒ IPë“¤: ${frontendIps}"
                    env.FRONTEND_IPS = frontendIps.join(' ')
                }
            }
        }
        stage('Load Frontend Env From SSM') {
            steps {
                script {
                    // 1) SSMì—ì„œ BACKEND_URL, API_PREFIX í•œ ë²ˆì— ì¡°íšŒ
                    def output = sh(
                        script: """
                        aws ssm get-parameters \\
                            --names "/community/BACKEND_URL" "/community/API_PREFIX" \\
                            --with-decryption \\
                            --query "Parameters[].[Name,Value]" \\
                            --output text \\
                            --region ${AWS_REGION} \\
                            --no-cli-pager
                        """,
                        returnStdout: true
                    ).trim()

                    echo "SSM raw output:\\n${output}"

                    // 2) ê²°ê³¼ íŒŒì‹±í•´ì„œ Mapìœ¼ë¡œ ë§Œë“¤ê¸°
                    def m = [:]
                    output.split("\\n").each { line ->
                        def parts = line.split("\\t", 2)   // tab ê¸°ì¤€ìœ¼ë¡œ Name / Value ë¶„ë¦¬
                        if (parts.size() == 2) {
                            def name  = parts[0]
                            def value = parts[1]
                            switch (name) {
                                case '/community/BACKEND_URL':
                                    m.BACKEND_URL = value
                                    break
                                case '/community/API_PREFIX':
                                    m.API_PREFIX = value
                                    break
                            }
                        }
                    }

                    if (!m.BACKEND_URL || !m.API_PREFIX) {
                        error "SSMì—ì„œ BACKEND_URL / API_PREFIXë¥¼ ëª¨ë‘ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ íŒŒì‹±ëœ ê°’: ${m}"
                    }

                    // 3) ì´í›„ Stageì—ì„œ ì“¸ ìˆ˜ ìˆë„ë¡ env ë¡œ ì €ì¥
                    env.FRONTEND_BACKEND_URL = m.BACKEND_URL
                    env.FRONTEND_API_PREFIX  = m.API_PREFIX

                    echo "FRONTEND_BACKEND_URL=${env.FRONTEND_BACKEND_URL}"
                    echo "FRONTEND_API_PREFIX=${env.FRONTEND_API_PREFIX}"
                }
            }
        }
        stage('Deploy Frontend') {
            steps {
                sshagent(credentials: ['ktb-personal-project-ec2-ssh-key']) {  // ğŸ”’ SSH í‚¤ ê³ ì •
                    script {
                        def ipsText = env.FRONTEND_IPS?.trim()
                        if (!ipsText) {
                            error "í”„ë¡ íŠ¸ì—”ë“œ IPê°€ ì—†ìŠµë‹ˆë‹¤."
                        }

                        def ips = (ipsText.split(' ') as List<String>)
                        echo "í”„ë¡ íŠ¸ì—”ë“œ ëŒ€ìƒ IPë“¤(ë°°í¬ìš©): ${ips}"

                        def finalTag = "fe-${params.IMAGE_DATE_TAG}".trim()
                        echo "í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ íƒœê·¸: ${finalTag}"
                        echo "ì‚¬ìš©í•  BACKEND_URL=${env.FRONTEND_BACKEND_URL}"
                        echo "ì‚¬ìš©í•  API_PREFIX=${env.FRONTEND_API_PREFIX}"

                        ips.each { ip ->
                            echo "í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ëŒ€ìƒ: ${ip}"
                            sh """
                            ssh -o StrictHostKeyChecking=no ubuntu@${ip} \\
                                'BACKEND_URL="${env.FRONTEND_BACKEND_URL}" \\
                                API_PREFIX="${env.FRONTEND_API_PREFIX}" \\
                                REGISTRY="${REGISTRY}" \\
                                IMAGE_NAME="${IMAGE_NAME}" \\
                                IMAGE_TAG="${finalTag}" \\
                                /mnt/efs/deploy/frontend/deploy-frontend.sh'
                            """
                        }
                    }
                }
            }
        }
    }
}
